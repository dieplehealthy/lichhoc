<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lịch học, việc cần làm</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .day-card { border-radius: 16px; min-height: 160px; transition: transform .12s, box-shadow .12s; padding: 1rem; }
    .day-card.drag-over { box-shadow: 0 0 0 4px rgba(91,33,182,0.25); transform: scale(1.02); }
    /* Đổi màu chữ thành màu tối để đảm bảo độ tương phản */
    .task-item { border-radius: 12px; padding: 0.5rem; margin-top: .5rem; color: #1f2937; cursor: grab; user-select: none; font-weight: 500; }
    .task-item.dragging { opacity: .6; }
    #sidebar { z-index: 60; right: 0; top: 0; }
    /* full-width small display fixes */
    #current-week-display { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>
</head>
<body class="p-4 bg-gray-50 text-gray-900">

<div class="container mx-auto max-w-4xl">
  <!-- Header -->
  <header class="flex justify-between items-center py-2 px-4">
    <h1 class="text-xl sm:text-2xl font-bold">Lịch học</h1>
    <div class="flex items-center gap-3">
      <span id="sync-dot" class="inline-block w-3 h-3 rounded-full bg-gray-400"></span>
      <button id="menu-toggle" class="text-gray-600 p-2 rounded hover:bg-gray-100">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </header>

  <!-- Navigation -->
  <div class="flex items-center p-2 gap-2">
    <button id="prev-week-btn" class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm">
      <i class="fas fa-arrow-left"></i>
    </button>

    <div class="text-center flex-1 px-2">
      <h2 id="current-week-display" class="text-sm font-semibold"></h2>
      <div class="text-xs text-blue-500 mt-1 hidden sm:block">
        <button id="copy-last-week-btn-inline" class="underline hover:text-blue-700">Sao chép lịch từ tuần trước</button>
      </div>
    </div>

    <button id="next-week-btn" class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm">
      <i class="fas fa-arrow-right"></i>
    </button>
  </div>

  <!-- Week view -->
  <div id="week-view" class="grid grid-cols-2 lg:grid-cols-3 gap-3 p-4">
    <div id="T2" class="day-card bg-pink-100"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold">T2</h3><button onclick="openAddTaskModal('T2')" class="text-xl hover:bg-pink-200 rounded px-2">+</button></div><div id="tasks-T2"></div></div>
    <div id="T3" class="day-card bg-purple-100"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold">T3</h3><button onclick="openAddTaskModal('T3')" class="text-xl hover:bg-purple-200 rounded px-2">+</button></div><div id="tasks-T3"></div></div>
    <div id="T4" class="day-card bg-blue-100"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold">T4</h3><button onclick="openAddTaskModal('T4')" class="text-xl hover:bg-blue-200 rounded px-2">+</button></div><div id="tasks-T4"></div></div>
    <div id="T5" class="day-card bg-green-100"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold">T5</h3><button onclick="openAddTaskModal('T5')" class="text-xl hover:bg-green-200 rounded px-2">+</button></div><div id="tasks-T5"></div></div>
    <div id="T6" class="day-card bg-yellow-100"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold">T6</h3><button onclick="openAddTaskModal('T6')" class="text-xl hover:bg-yellow-200 rounded px-2">+</button></div><div id="tasks-T6"></div></div>
    <div id="T7" class="day-card bg-stone-100"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold">T7</h3><button onclick="openAddTaskModal('T7')" class="text-xl hover:bg-stone-200 rounded px-2">+</button></div><div id="tasks-T7"></div></div>
    <div id="CN" class="day-card bg-gray-200"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold">CN</h3><button onclick="openAddTaskModal('CN')" class="text-xl hover:bg-gray-300 rounded px-2">+</button></div><div id="tasks-CN"></div></div>
  </div>

  <!-- Month view -->
  <div id="month-view" class="hidden p-4">
    <div id='calendar'></div>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebar" class="fixed top-0 right-0 w-72 h-full bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out">
  <div class="p-4 space-y-4">
    <div class="flex justify-between items-center">
      <h3 class="font-semibold text-lg">Tùy chọn</h3>
      <button id="sidebar-close" class="text-gray-600 p-1 rounded hover:bg-gray-100">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <button id="copy-last-week-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
      <i class="fas fa-copy"></i>
      <span>Sao chép tuần trước</span>
    </button>

    <button id="toggle-view-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
      <i id="view-icon" class="fas fa-calendar"></i>
      <span id="view-text">Chuyển xem tháng</span>
    </button>

    <button id="delete-all-week-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
      <i class="fas fa-trash-alt"></i>
      <span>Xóa tất cả tuần này</span>
    </button>
  </div>
</div>

<!-- Modal -->
<div id="task-modal" class="fixed inset-0 bg-gray-800 bg-opacity-40 flex items-center justify-center p-4 hidden z-50">
  <div class="bg-white p-5 rounded-xl w-full max-w-sm shadow-lg">
    <h2 id="modal-title" class="text-lg font-semibold mb-3">Thêm môn học</h2>
    <input id="task-text" class="w-full border rounded p-2 mb-2 bg-white border-gray-300 text-gray-900" placeholder="Nội dung môn / việc"/>
    <div class="flex gap-2 mb-2">
      <select id="task-day" class="flex-1 border rounded p-2 bg-white border-gray-300 text-gray-900">
        <option value="T2">Thứ 2</option><option value="T3">Thứ 3</option><option value="T4">Thứ 4</option>
        <option value="T5">Thứ 5</option><option value="T6">Thứ 6</option><option value="T7">Thứ 7</option>
        <option value="CN">Chủ Nhật</option>
      </select>
      <input id="task-color" type="color" class="w-14 p-0 rounded border border-gray-300" value="#5B21B6"/>
    </div>
    <input id="task-date" type="date" class="hidden"/>
    <div id="task-last-updated" class="text-xs text-gray-500 mb-2"></div>
    <div class="flex justify-end gap-2">
      <button id="delete-task-btn" onclick="deleteTask()" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded hidden transition-colors">Xóa</button>
      <button onclick="closeModal()" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded transition-colors">Hủy</button>
      <button id="save-task-btn" onclick="saveTask()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded transition-colors">Lưu</button>
    </div>
  </div>
</div>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCy8NFWttHP28NyKflMD8uHJeemHYoyFa0",
    authDomain: "lichhoc-fcf35.firebaseapp.com",
    projectId: "lichhoc-fcf35",
    storageBucket: "lichhoc-fcf35.firebasestorage.app",
    messagingSenderId: "262588554121",
    appId: "1:262588554121:web:e06728ccd6665673045f58"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const appId = firebaseConfig.projectId;
  const tasksCollectionRef = collection(db, "artifacts", appId, "public", "data", "tasks");

  // State
  let currentEditingTask = null;
  let currentDate = new Date();
  let unsubscribeWeek = null;
  let draggedElement = null;
  let calendarVisible = false;
  let calendarInstance = null;
  const dayMap = { 'T2':0,'T3':1,'T4':2,'T5':3,'T6':4,'T7':5,'CN':6 };
  const dayIndexToKey = ['T2','T3','T4','T5','T6','T7','CN'];

  // Update view button text and icon
  function updateViewButton() {
    const viewText = document.getElementById('view-text');
    const viewIcon = document.getElementById('view-icon');
    if (calendarVisible) {
      viewText.textContent = 'Chuyển xem tuần';
      viewIcon.className = 'fas fa-list';
    } else {
      viewText.textContent = 'Chuyển xem tháng';
      viewIcon.className = 'fas fa-calendar';
    }
  }

  // Helpers
  function getWeekDateRange(date) {
    const start = new Date(date);
    const dayOfWeek = start.getDay();
    const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    start.setDate(date.getDate() - diff);
    start.setHours(0,0,0,0);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    end.setHours(23,59,59,999);
    return { start, end };
  }

  function formatDate(date) {
    if (typeof date === 'string') return date;
    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2,'0');
    const d = String(date.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }

  function updateDateDisplay() {
    const { start, end } = getWeekDateRange(currentDate);
    const opt = { day: '2-digit', month: '2-digit' };
    document.getElementById('current-week-display').textContent = `Tuần từ ${start.toLocaleDateString('vi-VN', opt)} đến ${end.toLocaleDateString('vi-VN', opt)}`;
  }

  // Setup day-card drop listeners (once)
  function initDayCardDropHandlers() {
    document.querySelectorAll('.day-card').forEach(card => {
      // dragover
      card.addEventListener('dragover', (e) => {
        e.preventDefault();
        card.classList.add('drag-over');
      });
      card.addEventListener('dragenter', () => card.classList.add('drag-over'));
      card.addEventListener('dragleave', () => card.classList.remove('drag-over'));
      card.addEventListener('drop', async (e) => {
        e.preventDefault();
        card.classList.remove('drag-over');
        const taskId = e.dataTransfer.getData('text/plain') || (draggedElement && draggedElement.dataset.taskId);
        if (!taskId) return;
        const newDay = card.id;
        const { start } = getWeekDateRange(currentDate);
        const newDate = new Date(start);
        newDate.setDate(start.getDate() + dayMap[newDay]);
        try {
          const ref = doc(db, "artifacts", appId, "public", "data", "tasks", taskId);
          await setDoc(ref, { day: newDay, date: formatDate(newDate), updatedAt: new Date().toISOString() }, { merge: true });
        } catch (err) {
          console.error("Lỗi khi di chuyển task:", err);
        }
      });
    });
  }

  // Realtime listener for week
  function setupWeekListener() {
    if (unsubscribeWeek) unsubscribeWeek();
    updateDateDisplay();
    const { start, end } = getWeekDateRange(currentDate);
    const q = query(tasksCollectionRef, where("date", ">=", formatDate(start)), where("date", "<=", formatDate(end)));
    unsubscribeWeek = onSnapshot(q, (snapshot) => {
      document.getElementById('sync-dot').style.backgroundColor = 'green';
      const tasksByDay = { T2:[], T3:[], T4:[], T5:[], T6:[], T7:[], CN:[] };
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        if (d.day && tasksByDay[d.day]) tasksByDay[d.day].push({ id: docSnap.id, ...d });
      });
      renderTasks(tasksByDay);
      renderMonth(tasksByDay);
    }, (err) => {
      console.error("Listener error:", err);
      document.getElementById('sync-dot').style.backgroundColor = 'red';
    });
  }

  // Render week tasks (with drag handlers)
  function renderTasks(tasksByDay) {
    Object.keys(tasksByDay).forEach(day => {
      const container = document.getElementById(`tasks-${day}`);
      if (!container) return;
      container.innerHTML = '';
      tasksByDay[day].sort((a,b) => (a.text||'').localeCompare(b.text||''));
      tasksByDay[day].forEach(task => {
        const el = document.createElement('div');
        el.className = 'task-item p-2 mb-1 rounded transition-all hover:shadow-md';
        el.style.backgroundColor = task.color || '#5B21B6';
        el.textContent = task.text || '(không tên)';
        el.setAttribute('draggable', 'true');
        el.dataset.taskId = task.id;
        el.dataset.taskDay = task.day || '';
        el.dataset.taskDate = task.date || '';
        // click -> edit
        el.addEventListener('click', (e) => { e.stopPropagation(); openEditTaskModal(task); });
        // dragstart
        el.addEventListener('dragstart', (e) => {
          draggedElement = e.target;
          try { e.dataTransfer.setData('text/plain', task.id); } catch (ex) { /* some browsers */ }
          e.dataTransfer.effectAllowed = 'move';
          e.target.classList.add('dragging');
        });
        el.addEventListener('dragend', (e) => {
          draggedElement = null;
          e.target.classList.remove('dragging');
        });
        container.appendChild(el);
      });
    });
  }

  // Render month (FullCalendar) from tasksByDay
  function renderMonth(tasksByDay) {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;
    
    const events = [];
    Object.keys(tasksByDay).forEach(day => {
      tasksByDay[day].forEach(task => {
        events.push({
          id: task.id,
          title: task.text || '(không tên)',
          start: task.date,
          allDay: true,
          backgroundColor: task.color || '#5B21B6',
          borderColor: task.color || '#5B21B6',
          extendedProps: { day: task.day, updatedAt: task.updatedAt }
        });
      });
    });

    // Initialize or update calendar
    if (!calendarInstance) {
      calendarInstance = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'vi',
        height: 'auto',
        headerToolbar: { 
          left: 'prev,next today', 
          center: 'title', 
          right: 'dayGridMonth,dayGridWeek' 
        },
        events,
        dateClick: function(info) {
          openAddTaskModal(info.date);
          document.getElementById('task-date').value = formatDate(info.date);
        },
        eventClick: function(info) {
          const ev = info.event;
          openEditTaskModal({
            id: ev.id,
            text: ev.title,
            date: formatDate(new Date(ev.start)),
            day: ev.extendedProps?.day,
            color: ev.backgroundColor || ev.extendedProps?.color,
            updatedAt: ev.extendedProps?.updatedAt
          });
        }
      });
      calendarInstance.render();
    } else {
      // Update existing calendar
      calendarInstance.removeAllEvents();
      events.forEach(ev => calendarInstance.addEvent(ev));
    }
  }

  // Delete all tasks in current week
  async function deleteAllWeekTasks() {
    if (!confirm("Bạn có chắc chắn muốn xóa TẤT CẢ môn học trong tuần này không?\n\nHành động này KHÔNG THỂ HOÀN TÁC!")) return;
    
    const { start, end } = getWeekDateRange(currentDate);
    const q = query(tasksCollectionRef, where("date", ">=", formatDate(start)), where("date", "<=", formatDate(end)));
    
    try {
      const snapshot = await getDocs(q);
      
      if (snapshot.empty) {
        alert("Không có môn học nào trong tuần này để xóa!");
        return;
      }

      const batch = writeBatch(db);
      let deleteCount = 0;
      
      snapshot.forEach((docSnap) => {
        batch.delete(doc(db, "artifacts", appId, "public", "data", "tasks", docSnap.id));
        deleteCount++;
      });

      await batch.commit();
      alert(`Đã xóa thành công ${deleteCount} môn học!`);
      
    } catch (err) {
      console.error("Lỗi khi xóa tất cả tasks:", err);
      alert("Đã xảy ra lỗi khi xóa. Vui lòng thử lại!");
    }
  }

  // Copy last week -> this week
  async function copyLastWeekSchedule() {
    if (!confirm("Bạn có muốn sao chép toàn bộ lịch của tuần trước sang tuần này không?")) return;
    const lastWeekDate = new Date(currentDate);
    lastWeekDate.setDate(currentDate.getDate() - 7);
    const { start: lastStart, end: lastEnd } = getWeekDateRange(lastWeekDate);
    const q = query(tasksCollectionRef, where("date", ">=", formatDate(lastStart)), where("date", "<=", formatDate(lastEnd)));
    
    try {
      const snap = await getDocs(q);
      if (snap.empty) { 
        alert("Không tìm thấy môn học nào ở tuần trước để sao chép!"); 
        return; 
      }
      
      const { start: currentWeekStart } = getWeekDateRange(currentDate);
      const batch = writeBatch(db);
      let copied = 0;
      
      snap.forEach(docSnap => {
        const t = docSnap.data();
        const offset = dayMap[t.day];
        if (offset !== undefined) {
          const newDate = new Date(currentWeekStart);
          newDate.setDate(currentWeekStart.getDate() + offset);
          const newTask = { ...t, date: formatDate(newDate), createdAt: new Date().toISOString() };
          const newRef = doc(collection(db, "artifacts", appId, "public", "data", "tasks"));
          batch.set(newRef, newTask);
          copied++;
        }
      });
      
      await batch.commit();
      alert(`Đã sao chép ${copied} môn học từ tuần trước!`);
    } catch (err) {
      console.error("Lỗi khi commit batch:", err);
      alert("Đã xảy ra lỗi khi sao chép. Xem console.");
    }
  }

  // Modal + CRUD
  window.openAddTaskModal = (dayOrDate) => {
    currentEditingTask = null;
    document.getElementById('modal-title').textContent = 'Thêm môn học';
    document.getElementById('task-text').value = '';
    document.getElementById('delete-task-btn').classList.add('hidden');

    if (typeof dayOrDate === 'string' && ['T2','T3','T4','T5','T6','T7','CN'].includes(dayOrDate)) {
      document.getElementById('task-day').value = dayOrDate;
      const { start } = getWeekDateRange(currentDate);
      const d = new Date(start); d.setDate(start.getDate() + dayMap[dayOrDate]);
      document.getElementById('task-date').value = formatDate(d);
    } else if (dayOrDate) {
      const dt = (dayOrDate instanceof Date) ? dayOrDate : new Date(dayOrDate);
      const weekDay = dt.getDay();
      const key = weekDay === 0 ? 'CN' : dayIndexToKey[weekDay - 1];
      document.getElementById('task-day').value = key;
      document.getElementById('task-date').value = formatDate(dt);
    } else {
      document.getElementById('task-day').value = 'T2';
      const { start } = getWeekDateRange(currentDate);
      document.getElementById('task-date').value = formatDate(start);
    }
    document.getElementById('task-color').value = '#5B21B6';
    document.getElementById('task-last-updated').textContent = '';
    document.getElementById('task-modal').classList.remove('hidden');
    document.getElementById('task-text').focus();
  };

  window.openEditTaskModal = (task) => {
    currentEditingTask = task;
    document.getElementById('modal-title').textContent = 'Sửa môn học';
    document.getElementById('task-text').value = task.text || '';
    document.getElementById('task-day').value = task.day || 'T2';
    document.getElementById('task-color').value = task.color || '#5B21B6';
    document.getElementById('task-date').value = task.date || '';
    document.getElementById('task-last-updated').textContent = task.updatedAt ? `Sửa lần cuối: ${new Date(task.updatedAt).toLocaleString('vi-VN')}` : '';
    document.getElementById('delete-task-btn').classList.remove('hidden');
    document.getElementById('task-modal').classList.remove('hidden');
    document.getElementById('task-text').focus();
  };

  window.closeModal = () => {
    document.getElementById('task-modal').classList.add('hidden');
    currentEditingTask = null;
  };

  window.saveTask = async () => {
    const text = document.getElementById('task-text').value.trim();
    if (!text) { 
      alert('Vui lòng nhập nội dung môn học!'); 
      document.getElementById('task-text').focus();
      return; 
    }
    const day = document.getElementById('task-day').value;
    const color = document.getElementById('task-color').value || '#5B21B6';
    const dateVal = document.getElementById('task-date').value;
    let finalDate;
    if (dateVal) finalDate = dateVal;
    else {
      const { start } = getWeekDateRange(currentDate);
      const d = new Date(start);
      d.setDate(start.getDate() + dayMap[day]);
      finalDate = formatDate(d);
    }
    const payload = { text, day, color, date: finalDate, updatedAt: new Date().toISOString() };
    try {
      if (currentEditingTask && currentEditingTask.id) {
        const ref = doc(db, "artifacts", appId, "public", "data", "tasks", currentEditingTask.id);
        await setDoc(ref, payload, { merge: true });
      } else {
        payload.createdAt = new Date().toISOString();
        await setDoc(doc(collection(db, "artifacts", appId, "public", "data", "tasks")), payload);
      }
      closeModal();
      // onSnapshot sẽ cập nhật view tự động
    } catch (err) {
      console.error("Lưu lỗi:", err);
      alert("Lỗi khi lưu. Xem console.");
    }
  };

  window.deleteTask = async () => {
    if (!currentEditingTask || !currentEditingTask.id) return;
    if (!confirm('Bạn có chắc muốn xóa môn học này không?')) return;
    try {
      await deleteDoc(doc(db, "artifacts", appId, "public", "data", "tasks", currentEditingTask.id));
      closeModal();
    } catch (err) {
      console.error("Xóa lỗi:", err);
      alert("Lỗi khi xóa. Xem console.");
    }
  };

  // UI interactions
  document.getElementById('prev-week-btn').addEventListener('click', () => {
    currentDate.setDate(currentDate.getDate() - 7);
    setupWeekListener();
  });
  
  document.getElementById('next-week-btn').addEventListener('click', () => {
    currentDate.setDate(currentDate.getDate() + 7);
    setupWeekListener();
  });

  // Sidebar show/hide
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menu-toggle');
  const sidebarClose = document.getElementById('sidebar-close');

  function openSidebar() { 
    sidebar.classList.remove('translate-x-full'); 
    document.body.classList.add('overflow-hidden'); 
  }
  
  function closeSidebar() { 
    sidebar.classList.add('translate-x-full'); 
    document.body.classList.remove('overflow-hidden'); 
  }

  menuToggle.addEventListener('click', (e) => { 
    e.stopPropagation();
    if (sidebar.classList.contains('translate-x-full')) {
      openSidebar(); 
    } else {
      closeSidebar();
    }
  });
  
  sidebarClose.addEventListener('click', closeSidebar);

  // Close sidebar when clicking outside
  document.addEventListener('click', (e) => {
    const isInsideSidebar = sidebar.contains(e.target);
    const isMenuButton = menuToggle.contains(e.target);
    const isModal = document.getElementById('task-modal').contains(e.target);
    
    if (!isInsideSidebar && !isMenuButton && !isModal && !sidebar.classList.contains('translate-x-full')) {
      closeSidebar();
    }
  });

  // Copy week actions
  document.getElementById('copy-last-week-btn').addEventListener('click', async (e) => { 
    e.stopPropagation();
    await copyLastWeekSchedule(); 
    closeSidebar(); 
  });
  
  document.getElementById('copy-last-week-btn-inline').addEventListener('click', async (e) => { 
    e.stopPropagation();
    await copyLastWeekSchedule(); 
  });

  // Delete all week tasks
  document.getElementById('delete-all-week-btn').addEventListener('click', async (e) => {
    e.stopPropagation();
    await deleteAllWeekTasks();
    closeSidebar();
  });

  // Toggle week/month view
  document.getElementById('toggle-view-btn').addEventListener('click', (e) => {
    e.stopPropagation();
    calendarVisible = !calendarVisible;
    
    const weekView = document.getElementById('week-view');
    const monthView = document.getElementById('month-view');
    
    if (calendarVisible) {
      weekView.classList.add('hidden');
      monthView.classList.remove('hidden');
      // Ensure calendar is rendered when switching to month view
      if (calendarInstance) {
        setTimeout(() => {
          calendarInstance.render();
        }, 100);
      }
    } else {
      weekView.classList.remove('hidden');
      monthView.classList.add('hidden');
    }
    
    updateViewButton();
    closeSidebar();
  });

  // Close modal on backdrop click or ESC
  document.getElementById('task-modal').addEventListener('click', (e) => { 
    if (e.target === document.getElementById('task-modal')) {
      closeModal(); 
    }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // ESC key
    if (e.key === 'Escape') {
      if (!document.getElementById('task-modal').classList.contains('hidden')) {
        closeModal();
      } else if (!sidebar.classList.contains('translate-x-full')) {
        closeSidebar();
      }
    }
    
    // Enter key in modal
    if (e.key === 'Enter' && !document.getElementById('task-modal').classList.contains('hidden')) {
      e.preventDefault();
      window.saveTask();
    }
    
    // Arrow keys for week navigation (when not in modal)
    if (document.getElementById('task-modal').classList.contains('hidden')) {
      if (e.key === 'ArrowLeft' && e.ctrlKey) {
        e.preventDefault();
        currentDate.setDate(currentDate.getDate() - 7);
        setupWeekListener();
      } else if (e.key === 'ArrowRight' && e.ctrlKey) {
        e.preventDefault();
        currentDate.setDate(currentDate.getDate() + 7);
        setupWeekListener();
      }
    }
  });

  // Prevent sidebar from closing when clicking inside it
  sidebar.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // Initialize everything
  function init() {
    updateViewButton();
    initDayCardDropHandlers();
    setupWeekListener();
    
    // Add loading indicator
    document.getElementById('sync-dot').style.backgroundColor = 'orange';
    
    console.log('App initialized successfully');
  }

  // Start the app
  init();

</script>

</body>
</html>
