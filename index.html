<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lịch học, việc cần làm</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    #sidebar { z-index: 9999; }
    .day-card { border-radius: 16px; min-height: 200px; }
  </style>
</head>
<body class="p-4 bg-gray-50 dark:bg-gray-900 dark:text-gray-100">

<div class="container mx-auto max-w-4xl">
  <!-- Header -->
  <header class="flex justify-between items-center py-2 px-4">
    <h1 class="text-xl sm:text-2xl font-bold">Lịch học</h1>
    <button id="menu-toggle" class="text-gray-500 dark:text-gray-300">
      <i class="fas fa-bars"></i>
    </button>
  </header>

  <!-- Navigation -->
  <div class="flex justify-between items-center p-2 gap-2">
    <button id="prev-week-btn" class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm">
      <i class="fas fa-arrow-left"></i>
    </button>

    <div class="text-center flex-1">
      <h2 id="current-week-display" class="text-sm font-semibold"></h2>
    </div>

    <button id="next-week-btn" class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm">
      <i class="fas fa-arrow-right"></i>
    </button>
  </div>

  <!-- Views -->
  <div id="week-view" class="grid grid-cols-2 lg:grid-cols-3 gap-3 p-4">
    <div id="T2" class="day-card bg-pink-200 p-4"><h2 class="font-semibold mb-2">T2</h2><div id="tasks-T2"></div></div>
    <div id="T3" class="day-card bg-purple-200 p-4"><h2 class="font-semibold mb-2">T3</h2><div id="tasks-T3"></div></div>
    <div id="T4" class="day-card bg-blue-200 p-4"><h2 class="font-semibold mb-2">T4</h2><div id="tasks-T4"></div></div>
    <div id="T5" class="day-card bg-green-100 p-4"><h2 class="font-semibold mb-2">T5</h2><div id="tasks-T5"></div></div>
    <div id="T6" class="day-card bg-yellow-200 p-4"><h2 class="font-semibold mb-2">T6</h2><div id="tasks-T6"></div></div>
    <div id="T7" class="day-card bg-gray-200 p-4"><h2 class="font-semibold mb-2">T7</h2><div id="tasks-T7"></div></div>
    <div id="CN" class="day-card bg-red-200 p-4"><h2 class="font-semibold mb-2">CN</h2><div id="tasks-CN"></div></div>
  </div>

  <div id="month-view" class="hidden p-4">
    <p class="text-center text-gray-500">(Chế độ xem tháng sẽ hiển thị ở đây)</p>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebar" class="fixed top-0 right-0 w-64 h-full bg-white dark:bg-gray-800 shadow-lg transform translate-x-full transition-transform">
  <div class="p-4 space-y-4">
    <button id="theme-toggle" class="w-full px-3 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">
      <i class="fas fa-moon"></i> Giao diện
    </button>
    <button id="copy-last-week-btn" class="w-full px-3 py-2 bg-blue-500 text-white rounded-lg">
      <i class="fas fa-copy"></i> Sao chép tuần trước
    </button>
    <button id="toggle-view-btn" class="w-full px-3 py-2 bg-green-500 text-white rounded-lg">
      <i class="fas fa-calendar"></i> Xem theo tháng
    </button>
  </div>
</div>

<!-- Modal -->
<div id="task-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden">
  <div class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow-xl w-full max-w-sm">
    <h2 id="modal-title" class="text-xl font-bold mb-4">Thêm môn học</h2>
    <input type="text" id="task-text" class="w-full border rounded-lg mb-4 p-2" placeholder="Nội dung">
    <select id="task-day" class="w-full border rounded-lg mb-4 p-2">
      <option value="T2">Thứ 2</option><option value="T3">Thứ 3</option><option value="T4">Thứ 4</option>
      <option value="T5">Thứ 5</option><option value="T6">Thứ 6</option><option value="T7">Thứ 7</option>
      <option value="CN">Chủ Nhật</option>
    </select>
    <input type="color" id="task-color" class="w-full h-10 border rounded-lg mb-4" value="#5B21B6">
    <div id="task-last-updated" class="text-sm text-gray-500 mb-4"></div>
    <div class="flex justify-end space-x-2">
      <button id="delete-task-btn" onclick="deleteTask()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 hidden">Xóa</button>
      <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Hủy</button>
      <button id="save-task-btn" onclick="saveTask()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Lưu</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCy8NFWttHP28NyKflMD8uHJeemHYoyFa0",
    authDomain: "lichhoc-fcf35.firebaseapp.com",
    projectId: "lichhoc-fcf35",
    storageBucket: "lichhoc-fcf35.firebasestorage.app",
    messagingSenderId: "262588554121",
    appId: "1:262588554121:web:e06728ccd6665673045f58"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const appId = firebaseConfig.projectId;
  const tasksCollectionRef = collection(db, "artifacts", appId, "public", "data", "tasks");

  let currentEditingTask = null;
  let currentDate = new Date();
  let unsubscribe;
  const dayMap = { T2:0, T3:1, T4:2, T5:3, T6:4, T7:5, CN:6 };

  function getWeekDateRange(date) { const start=new Date(date); const d=start.getDay(); const diff=d===0?6:d-1; start.setDate(date.getDate()-diff); start.setHours(0,0,0,0); const end=new Date(start); end.setDate(start.getDate()+6); end.setHours(23,59,59,999); return {start,end}; }
  function formatDate(date){return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;}

  function updateDateDisplay(){const {start,end}=getWeekDateRange(currentDate);const opt={day:'2-digit',month:'2-digit'};document.getElementById('current-week-display').textContent=`${start.toLocaleDateString('vi-VN',opt)} - ${end.toLocaleDateString('vi-VN',opt)}`;}

  function setupRealtimeListener(){ if(unsubscribe) unsubscribe(); updateDateDisplay(); const {start,end}=getWeekDateRange(currentDate); const q=query(tasksCollectionRef, where("date", ">=", formatDate(start)), where("date", "<=", formatDate(end))); unsubscribe=onSnapshot(q,(snap)=>{const tasksByDay={T2:[],T3:[],T4:[],T5:[],T6:[],T7:[],CN:[]}; snap.forEach(doc=>{const d=doc.data(); if(d.day) tasksByDay[d.day].push({id:doc.id,...d});}); renderTasks(tasksByDay);}); }

  function renderTasks(tasksByDay){ Object.keys(tasksByDay).forEach(day=>{ const container=document.getElementById(`tasks-${day}`); container.innerHTML=''; tasksByDay[day].forEach(task=>{const div=document.createElement('div');div.className='task-item p-2 mb-1 rounded text-white cursor-pointer';div.style.backgroundColor=task.color||'#5B21B6';div.textContent=task.text;div.onclick=()=>openEditTaskModal(task);container.appendChild(div);}); }); }

  async function copyLastWeekSchedule(){ if(!confirm("Sao chép tuần trước?")) return; const lastWeek=new Date(currentDate); lastWeek.setDate(currentDate.getDate()-7); const {start:lastStart,end:lastEnd}=getWeekDateRange(lastWeek); const q=query(tasksCollectionRef, where("date", ">=", formatDate(lastStart)), where("date", "<=", formatDate(lastEnd))); const snap=await getDocs(q); if(snap.empty){alert("Không có dữ liệu tuần trước!"); return;} const {start:thisStart}=getWeekDateRange(currentDate); const batch=writeBatch(db); let count=0; snap.forEach(docSnap=>{const task=docSnap.data(); const offset=dayMap[task.day]; if(offset!==undefined){const newDate=new Date(thisStart); newDate.setDate(thisStart.getDate()+offset); const newTask={...task,date:formatDate(newDate),createdAt:new Date().toISOString()}; const newRef=doc(collection(db,"artifacts",appId,"public","data","tasks")); batch.set(newRef,newTask); count++;}}); await batch.commit(); alert(`Đã sao chép ${count} môn học.`); }

  window.openAddTaskModal=(day)=>{currentEditingTask=null;document.getElementById('modal-title').textContent='Thêm môn học';document.getElementById('task-text').value='';document.getElementById('task-day').value=day;document.getElementById('task-color').value='#5B21B6';document.getElementById('task-modal').classList.remove('hidden');};
  window.openEditTaskModal=(task)=>{currentEditingTask=task;document.getElementById('modal-title').textContent='Sửa môn học';document.getElementById('task-text').value=task.text;document.getElementById('task-day').value=task.day;document.getElementById('task-color').value=task.color||'#5B21B6';document.getElementById('delete-task-btn').classList.remove('hidden');document.getElementById('task-modal').classList.remove('hidden');};
  window.closeModal=()=>document.getElementById('task-modal').classList.add('hidden');
  window.saveTask=async()=>{const text=document.getElementById('task-text').value.trim();if(!text)return;const day=document.getElementById('task-day').value;const {start}=getWeekDateRange(currentDate);const date=new Date(start);date.setDate(start.getDate()+dayMap[day]);const data={text,day,color:document.getElementById('task-color').value,date:formatDate(date),updatedAt:new Date().toISOString()}; if(currentEditingTask){await setDoc(doc(db,"artifacts",appId,"public","data","tasks",currentEditingTask.id),data,{merge:true});} else {data.createdAt=new Date().toISOString();await setDoc(doc(collection(db,"artifacts",appId,"public","data","tasks")),data);} closeModal();};
  window.deleteTask=async()=>{if(!currentEditingTask||!confirm("Xóa?"))return;await deleteDoc(doc(db,"artifacts",appId,"public","data","tasks",currentEditingTask.id));closeModal();};

  document.getElementById('prev-week-btn').addEventListener('click',()=>{currentDate.setDate(currentDate.getDate()-7);setupRealtimeListener();});
  document.getElementById('next-week-btn').addEventListener('click',()=>{currentDate.setDate(currentDate.getDate()+7);setupRealtimeListener();});
  document.getElementById('copy-last-week-btn').addEventListener('click',copyLastWeekSchedule);

  document.getElementById("menu-toggle").addEventListener("click",()=>{document.getElementById("sidebar").classList.toggle("translate-x-full");});
  const body=document.body; function updateThemeIcon(dark){document.getElementById("theme-toggle").innerHTML=dark?'<i class="fas fa-sun"></i> Giao diện':'<i class="fas fa-moon"></i> Giao diện';}
  if(localStorage.getItem('theme')==='dark'){body.classList.add('dark');updateThemeIcon(true);} document.getElementById("theme-toggle").addEventListener("click",()=>{const dark=body.classList.toggle('dark');localStorage.setItem('theme',dark?'dark':'light');updateThemeIcon(dark);});
  document.getElementById("toggle-view-btn").addEventListener("click",()=>{document.getElementById("week-view").classList.toggle("hidden");document.getElementById("month-view").classList.toggle("hidden");});

  setupRealtimeListener();
</script>

</body>
</html>
